version: '3'

tasks:
  # Default task - show help
  default:
    desc: Show available tasks and common workflows
    cmds:
      - task: help

  # === TESTING WORKFLOWS ===
  test:
    desc: Run comprehensive test suite including quality checks
    cmds:
      - echo "ğŸ§ª Running comprehensive test suite..."
      - julia --project=. --quiet -e 'using Pkg; Pkg.test()'
      - echo "âœ… All tests completed successfully"

  test-fast:
    desc: Run tests quickly (skip quality checks for development)
    cmds:
      - echo "ğŸ§ª Running fast test suite (skipping quality checks)..."
      - julia --project=. --quiet -e 'using Pkg; Pkg.test(test_args=["skip_quality"])'
      - echo "âœ… Fast tests completed"

  test-quality:
    desc: Run only quality checks (Aqua, formatting, linting, doctests)
    cmds:
      - echo "ğŸ” Running quality checks only..."
      - julia --project=. --quiet -e 'using Pkg; Pkg.test(test_args=["quality_only"])'
      - echo "âœ… Quality checks completed"

  test-extensions:
    desc: Test package extensions with OptimizationExt
    cmds:
      - echo "ğŸ”§ Testing package extensions..."
      - julia --project=docs --quiet -e 'using CensoredDistributions, Distributions, OptimizationOptimJL, Bijectors; println("âœ… Extensions loaded successfully")'

  format:
    desc: Format code with JuliaFormatter (fixes formatting issues)
    cmds:
      - echo "ğŸ¨ Formatting code with JuliaFormatter..."
      - julia --project=test --quiet -e 'using JuliaFormatter; format(".", verbose=false, overwrite=true)'
      - echo "âœ… Code formatting completed"

  format-check:
    desc: Check code formatting without making changes
    cmds:
      - echo "ğŸ” Checking code formatting..."
      - |
        julia --project=test --quiet -e 'using JuliaFormatter; success = format(".", verbose=false, overwrite=false); success || error("Code needs formatting - run: task format")'
      - echo "âœ… Code formatting is correct"

  coverage:
    desc: Run tests with coverage and generate coverage report
    cmds:
      - echo "ğŸ“Š Running tests with coverage..."
      - julia --project=. --code-coverage=user -e 'using Pkg; Pkg.test(test_args=["skip_quality"])'
      - echo "ğŸ“Š Processing coverage data..."
      - julia --project=test -e 'using Pkg; Pkg.add("Coverage"); using Coverage; coverage = process_folder(); LCOV.writefile("lcov.info", coverage)'
      - echo "âœ… Coverage report generated (lcov.info)"

  # === DOCUMENTATION WORKFLOWS ===
  docs:
    desc: Build complete documentation including Pluto notebooks (slow)
    cmds:
      - echo "ğŸ“š Building complete documentation (including notebooks)..."
      - julia --project=docs docs/make.jl
      - echo "âœ… Documentation built successfully"

  docs-fast:
    desc: Build documentation quickly (skip notebook processing)
    cmds:
      - echo "ğŸ“š Building documentation (skipping notebooks)..."
      - julia --project=docs docs/make.jl --skip-notebooks
      - echo "âœ… Fast documentation build completed"

  docs-pluto:
    desc: Start Pluto server for interactive notebook development
    cmds:
      - echo "ğŸš€ Starting Pluto server for interactive development..."
      - julia --project=docs -e 'using Pluto; Pluto.run()'

  # === DEVELOPMENT SETUP ===
  setup:
    desc: Set up development environment from scratch
    cmds:
      - echo "ğŸ› ï¸  Setting up development environment..."
      - echo "ğŸ“¦ Installing root environment dependencies..."
      - julia --project=. -e 'using Pkg; Pkg.instantiate()'
      - echo "ğŸ“¦ Installing test environment dependencies..."
      - julia --project=test -e 'using Pkg; Pkg.instantiate()'
      - echo "ğŸ“¦ Installing docs environment dependencies..."
      - julia --project=docs -e 'using Pkg; Pkg.instantiate()'
      - echo "ğŸ“¦ Installing benchmark environment dependencies..."
      - julia --project=benchmark -e 'using Pkg; Pkg.instantiate()'
      - echo "âœ… Development environment ready"

  setup-precompile:
    desc: Force precompilation of all environments
    cmds:
      - echo "ğŸ”„ Precompiling all environments..."
      - julia --project=. -e 'using Pkg; Pkg.precompile()'
      - julia --project=test -e 'using Pkg; Pkg.precompile()'
      - julia --project=docs -e 'using Pkg; Pkg.precompile()'
      - julia --project=benchmark -e 'using Pkg; Pkg.precompile()'
      - echo "âœ… Precompilation completed"

  # === PACKAGE MANAGEMENT ===
  pkg-status:
    desc: Show package status across all environments
    cmds:
      - echo "ğŸ“¦ Package status overview:"
      - echo ""
      - echo "=== Root Environment ==="
      - julia --project=. --quiet -e 'using Pkg; Pkg.status()'
      - echo ""
      - echo "=== Test Environment ==="
      - julia --project=test --quiet -e 'using Pkg; Pkg.status()'
      - echo ""
      - echo "=== Docs Environment ==="
      - julia --project=docs --quiet -e 'using Pkg; Pkg.status()'
      - echo ""
      - echo "=== Benchmark Environment ==="
      - julia --project=benchmark --quiet -e 'using Pkg; Pkg.status()'

  pkg-update:
    desc: Update packages in all environments
    interactive: true
    cmds:
      - |
        echo "âš ï¸  WARNING: This will update packages in all environments"
        printf "   Continue? [y/N] "
        read -r REPLY
        if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
          echo "ğŸ“¦ Updating root environment..."
          julia --project=. -e 'using Pkg; Pkg.update()'
          echo "ğŸ“¦ Updating test environment..."
          julia --project=test -e 'using Pkg; Pkg.update()'
          echo "ğŸ“¦ Updating docs environment..."
          julia --project=docs -e 'using Pkg; Pkg.update()'
          echo "ğŸ“¦ Updating benchmark environment..."
          julia --project=benchmark -e 'using Pkg; Pkg.update()'
          echo "âœ… All environments updated"
        else
          echo "âŒ Update cancelled"
        fi

  pkg-add:
    desc: "Add package to specified environment (usage: task pkg:add ENV=docs -- PackageName)"
    cmds:
      - |
        ENV_VAR={{.ENV | default "."}}
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Usage: task pkg:add ENV=<environment> -- <PackageName>"
          echo "Environments: . (root), test, docs, benchmark"
          echo "Example: task pkg:add ENV=docs -- PlutoStaticHTML"
          exit 1
        fi
        echo "ğŸ“¦ Adding {{.CLI_ARGS}} to $ENV_VAR environment..."
        julia --project=$ENV_VAR -e "using Pkg; Pkg.add(\"{{.CLI_ARGS}}\")"
        echo "âœ… Package added successfully"

  # === BENCHMARKS ===
  benchmark:
    desc: Run complete benchmark suite
    cmds:
      - echo "âš¡ Running benchmark suite..."
      - julia --project=benchmark benchmark/runbenchmarks.jl
      - echo "âœ… Benchmarks completed successfully"

  # === DEVELOPMENT WORKFLOWS ===
  dev:
    desc: Common development workflow (format + precommit + fast test + fast docs)
    cmds:
      - task: format
      - task: precommit
      - task: test-fast
      - task: docs-fast
      - echo "âœ… Development checks completed"

  dev-full:
    desc: Full development workflow (format + precommit + all tests + full docs)
    cmds:
      - task: format
      - task: precommit
      - task: test
      - task: docs
      - echo "âœ… Full development checks completed"

  precommit:
    desc: Run pre-commit formatting hooks only
    cmds:
      - echo "ğŸ¨ Running pre-commit formatting hooks..."
      - pre-commit run --all-files
      - echo "âœ… Pre-commit formatting completed"

  ci:
    desc: Simulate CI pipeline locally (comprehensive testing)
    cmds:
      - echo "ğŸ¤– Running CI simulation..."
      - task: precommit
      - task: test
      - task: docs-fast
      - task: benchmark
      - echo "âœ… CI simulation completed successfully"

  # === UTILITIES ===
  utils-uuid:
    desc: Generate UUID for Pluto notebooks
    cmds:
      - julia -e "using UUIDs; println(uuid4())"

  clean:
    desc: Clean build artifacts and temporary files
    interactive: true
    cmds:
      - |
        echo "âš ï¸  WARNING: This will delete build artifacts and temporary files"
        echo "   - docs/build/ directory"
        echo "   - .cov files"
        echo "   - Test environment Manifest.toml"
        printf "   Continue? [y/N] "
        read -r REPLY
        if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
          echo "ğŸ—‘ï¸  Cleaning build artifacts..."
          rm -rf docs/build/
          find . -name "*.cov" -delete
          rm -f test/Manifest.toml docs/Manifest.toml benchmark/Manifest.toml
          echo "âœ… Cleanup completed"
        else
          echo "âŒ Cleanup cancelled"
        fi

  # === INFORMATION ===
  info:
    desc: Show project information and environment status
    cmds:
      - echo "ğŸ“‹ CensoredDistributions.jl Project Information"
      - echo "==============================================="
      - |
        julia --project=. -e 'using Pkg; println("Julia version: ", VERSION); pkg = Pkg.project(); println("Package: ", pkg.name, " v", pkg.version)'
      - echo ""
      - task: pkg-status

  help:
    desc: Show available commands
    cmds:
      - task --list
